<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="utf-8">
    <title> Train Model</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/chessboard-1.0.0.min.css">
    <style type="text/css">
        body {
            background-color: lightgreen;
            margin-top: 10px;
        }
        
        #board {
            float: left;
            display: block;
        }
        
        #moveMade {
            display: block;
            float: left;
            font-size: 50px;
        }
        
        button {
            margin: 2px;
        }
        
        input {
            margin: 2px;
        }
    </style>
</head>

<body id="body">
    <div id="container" class="container">
        <div class="row">
            <div id="board" style="width: 400px"></div>
            <div id="moveMade">X</div>
        </div>
        <div class="row">
            Depth:
            <span id="depthSpan">0</span><br>
        </div>
        <div class="row">
            <input id="depthSlider" type="range" min="0" max="100" value="0">
        </div>
        <div class="row">
            <button class="btn btn-secondary" id="startTheTraining">Start Training</button>
            <button class="btn btn-secondary" id="CreateNewModels">Create new Models</button>
            <button class="btn btn-secondary" id="loadModel">Load Models</button>

            <button class="btn btn-secondary" id="playBestMove">Play best Move</button>
            <button class="btn btn-secondary" id="predictBestMove">Predict best move</button>


            <button class="btn btn-secondary" id="updateBoard">Update Board</button>

            <button class="btn btn-secondary" id="testMonteSpeed">Test Monte Speed</button>
        </div>
        <div class="row">
            <input type="text" id="saveModelName" placeholder="Save as">
            <button class="btn btn-secondary" id="saveModelToDownloads">Save Model to Downloads</button>
        </div>
        <div class="row">
            <input type="text" id="loadModelName" placeholder="Download name">
            <button class="btn btn-secondary" id="loadFromDownloads">Load Model from Downloads</button>
        </div>
    </div>

    <!-- bootstrap -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- jquery -->
    <script src="../js/jquery-3.5.1.min.js"></script>
    <!-- chessboard.js -->
    <script src="../js/chessboard-1.0.0.min.js"></script>
    <!-- chess.js -->
    <script src="../js/chess.js"></script>
    <!-- tensorflow.js -->
    <script src='../js/tf.min.js'></script>
    <!-- own scripts -->
    <script src="../js/ChessboardToNNInput.js"></script>
    <script src="../js/RandomNormalDistribution.js"></script>
    <script src="../js/NeuralNetwork.js"></script>
    <script src="../js/NeuralNetworkTrainer.js"></script>
    <script src="../js/monteCarloTreeSearch.js"></script>
    <script>
        async function changeGoal(goal) {
            NNTrainer.trainingGoal = goal;
        }
        let depth = localStorage.getItem("treeSearchDepth");
        if (depth == null) {
            localStorage.setItem("treeSearchDepth", 0);
        }
        let depth = document.getElementById("depthSlider").value;
        document.getElementById("testMonteSpeed").addEventListener("click", () => {
            NNTrainer.monteCarloSpeedTester();
        });
        document.getElementById("saveModelToDownloads").addEventListener("click", async() => {
            if (NNTrainer.models[0].model != null) {
                NNTrainer.saveModelToDownloads(document.getElementById("saveModelName").value);
            } else {
                console.log("model doesn't exist. save failed.")
            }
        });
        document.getElementById("loadFromDownloads").addEventListener("click", async() => {
            await NNTrainer.loadFromDownloads(document.getElementById("loadModelName").value);
            console.log("loaded model from downloads and saved it.");
        });

        let NNTrainer = new NeuralNetworkTrainer(new Chess());

        let monteCarlo = new monteCarloTreeSearch(new Chess(), depth);

        var game = new Chess();
        let board = Chessboard('board', 'start');

        document.getElementById("CreateNewModels").addEventListener("click", async() => {
            let models = await CreateNewModels().then(r => r);
            //console.log(models)
            for (let i = 0; i < models.length; i++) {
                await NNTrainer.addModelToTrainer(models[i]).then(r => null);
            }
            await mutateModels().then(response => NNTrainer.models[0].model.getWeights()[0].print());
            //NNTrainer.models[0].model.getWeights()[0].print();

        });

        async function mutateModels() {
            for (let j = 0; j < 100; j++) {
                for (let index = 0; index < NNTrainer.models.length; index++) {
                    await NNTrainer.models[index].extremeMutate(0.5);
                }
            }
            console.log("created new models");
        }

        document.getElementById("startTheTraining").addEventListener("click", async() => {
            if (NNTrainer != null) {
                let btn = document.getElementById("startTheTraining");
                if (btn.innerHTML == "Start Training") {
                    btn.innerHTML = "Pause Training";
                    NNTrainer.keepTraining = true;
                } else {
                    btn.innerHTML = "Start Training";
                    setTimeout(() => {
                        NNTrainer.keepTraining = false;
                    }, 100);

                }
                if (NNTrainer.keepTraining == true) {
                    await NNTrainer.startTraining();
                }
            }
        })

        async function CreateNewModels() {
            let models = []
            for (let index = 0; index < 10; index++) {
                models.push(new NeuralNet());
            }
            return models;
        }

        document.getElementById("playBestMove").addEventListener("click", playBestMoveFunction);

        function playBestMoveFunction() {
            game.move(possibleMovesMonte[bestMoveIndex]);
            board = Chessboard('board', game.fen());
        }

        document.getElementById("predictBestMove").addEventListener("click", () => {
            monteCarloTreeSearch(depth, NNTrainer.models[0].model)
        });

        document.getElementById("updateBoard").addEventListener("click", () => {
            board = Chessboard('board', game.fen());
        });

        var slider = document.getElementById("depthSlider");
        var depthSpan = document.getElementById("depthSpan");
        depthSpan.innerHTML = slider.value;

        slider.oninput = function() {
            depthSpan.innerHTML = this.value;
            monteCarlo.depth = this.value;
            localStorage.setItem("treeSearchDepth", this.value);
        }

        document.getElementById("loadModel").addEventListener("click", async() => {
            await NNTrainer.loadTheModels().then(r => console.log("loaded models"));
            await showProofOfLoadedModels().then(r => r)
        })


        async function showProofOfLoadedModels() {
            NNTrainer.models[0].model.getWeights()[0].print();
        }
    </script>
</body>

</html>